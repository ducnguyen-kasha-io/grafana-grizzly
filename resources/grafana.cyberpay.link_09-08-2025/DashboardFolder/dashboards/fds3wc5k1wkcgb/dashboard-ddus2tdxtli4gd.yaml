apiVersion: grizzly.grafana.com/v1alpha1
kind: Dashboard
metadata:
    folder: fds3wc5k1wkcgb
    name: ddus2tdxtli4gd
spec:
    annotations:
        list:
            - builtIn: 1
              datasource:
                type: grafana
                uid: -- Grafana --
              enable: true
              hide: true
              iconColor: rgba(0, 211, 255, 1)
              name: Annotations & Alerts
              type: dashboard
    editable: true
    fiscalYearStartMonth: 0
    graphTooltip: 0
    links: []
    panels:
        - datasource:
            type: haohanyang-mongodb-datasource
            uid: feu6yxrhwnrpca
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                custom:
                    align: auto
                    cellOptions:
                        type: auto
                    filterable: true
                    inspect: false
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: green
                        - color: red
                          value: 80
            overrides: []
          gridPos:
            h: 13
            w: 24
            x: 0
            "y": 0
          id: 1
          options:
            cellHeight: sm
            footer:
                countRows: false
                fields: ""
                reducer:
                    - sum
                show: false
            showHeader: true
            sortBy:
                - desc: true
                  displayName: merchantName
          pluginVersion: 11.6.4
          targets:
            - collection: transactions
              datasource:
                type: haohanyang-mongodb-datasource
                uid: feu6yxrhwnrpca
              isStreaming: false
              queryLanguage: json
              queryText: "[\r\n  {\r\n    \"$match\": {\r\n      \"$expr\": {\r\n        \"$and\": [\r\n          { \"$gte\": [\"$createdAt\", { \"$date\": \"2023-07-01T00:00:00.000Z\" }] },\r\n          { \"$lte\": [\"$createdAt\", { \"$date\": { \"$numberLong\": \"$__to\" } }] },\r\n          { \"$eq\": [\"$status\", \"COMPLETED\"] }\r\n        ]\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"createdAtMonth\": {\r\n        \"$dateToString\": {\r\n          \"format\": \"%Y-%m\",\r\n          \"date\": \"$createdAt\"\r\n        }\r\n      },\r\n      \"fxAmount\": \"$fx.amount\"\r\n    }\r\n  },\r\n  {\r\n    \"$group\": {\r\n      \"_id\": {\r\n        \"merchantId\": \"$merchantId\",\r\n        \"country\": \"$country\",\r\n        \"createdAtMonth\": \"$createdAtMonth\"\r\n      },\r\n      \"totalAmount\": {\r\n        \"$sum\": \"$fxAmount\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"merchants\",\r\n      \"localField\": \"_id.merchantId\",\r\n      \"foreignField\": \"_id\",\r\n      \"as\": \"merchantDetails\"\r\n    }\r\n  },\r\n  {\r\n    \"$unwind\": \"$merchantDetails\"\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"countries\",\r\n      \"localField\": \"_id.country\",\r\n      \"foreignField\": \"code\",\r\n      \"as\": \"countryDetails\"\r\n    }\r\n  },\r\n  {\r\n    \"$unwind\": \"$countryDetails\"\r\n  },\r\n  {\r\n    \"$group\": {\r\n      \"_id\": {\r\n        \"merchantName\": \"$merchantDetails.name\",\r\n        \"countryName\": \"$countryDetails.name\"\r\n      },\r\n      \"amounts\": {\r\n        \"$push\": {\r\n          \"month\": \"$_id.createdAtMonth\",\r\n          \"amount\": \"$totalAmount\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$project\": {\r\n      \"_id\": 0,\r\n      \"merchantName\": \"$_id.merchantName\",\r\n      \"countryName\": \"$_id.countryName\",\r\n      \"March_amount\": {\r\n        \"$cond\": [\r\n          { \"$in\": [\"2024-03\", \"$amounts.month\"] },\r\n          { \"$arrayElemAt\": [\"$amounts.amount\", { \"$indexOfArray\": [\"$amounts.month\", \"2024-03\"] }] },\r\n          0\r\n        ]\r\n      },\r\n      \"April_amount\": {\r\n        \"$cond\": [\r\n          { \"$in\": [\"2024-04\", \"$amounts.month\"] },\r\n          { \"$arrayElemAt\": [\"$amounts.amount\", { \"$indexOfArray\": [\"$amounts.month\", \"2024-04\"] }] },\r\n          0\r\n        ]\r\n      },\r\n      \"May_amount\": {\r\n        \"$cond\": [\r\n          { \"$in\": [\"2024-05\", \"$amounts.month\"] },\r\n          { \"$arrayElemAt\": [\"$amounts.amount\", { \"$indexOfArray\": [\"$amounts.month\", \"2024-05\"] }] },\r\n          0\r\n        ]\r\n      },\r\n      \"June_amount\": {\r\n        \"$cond\": [\r\n          { \"$in\": [\"2024-06\", \"$amounts.month\"] },\r\n          { \"$arrayElemAt\": [\"$amounts.amount\", { \"$indexOfArray\": [\"$amounts.month\", \"2024-06\"] }] },\r\n          0\r\n        ]\r\n      },\r\n      \"July_amount\": {\r\n        \"$cond\": [\r\n          { \"$in\": [\"2024-07\", \"$amounts.month\"] },\r\n          { \"$arrayElemAt\": [\"$amounts.amount\", { \"$indexOfArray\": [\"$amounts.month\", \"2024-07\"] }] },\r\n          0\r\n        ]\r\n      },\r\n      \"August_amount\": {\r\n        \"$cond\": [\r\n          { \"$in\": [\"2024-08\", \"$amounts.month\"] },\r\n          { \"$arrayElemAt\": [\"$amounts.amount\", { \"$indexOfArray\": [\"$amounts.month\", \"2024-08\"] }] },\r\n          0\r\n        ]\r\n      }\r\n    }\r\n  }\r\n]"
              queryType: table
              refId: A
          title: Panel Title
          transformations:
            - id: organize
              options:
                excludeByName:
                    March_amount: true
                includeByName: {}
                indexByName:
                    April_amount: 2
                    August_amount: 6
                    July_amount: 5
                    June_amount: 4
                    March_amount: 7
                    May_amount: 3
                    countryName: 1
                    merchantName: 0
                renameByName: {}
            - id: calculateField
              options:
                mode: reduceRow
                reduce:
                    include:
                        - April_amount
                        - May_amount
                        - June_amount
                        - July_amount
                        - August_amount
                    reducer: sum
          type: table
    preload: false
    refresh: ""
    schemaVersion: 41
    tags: []
    templating:
        list: []
    time:
        from: now-6h
        to: now
    timepicker: {}
    timezone: browser
    title: Merchant total
    uid: ddus2tdxtli4gd
