apiVersion: grizzly.grafana.com/v1alpha1
kind: Dashboard
metadata:
    folder: fen97rev6xp8ga
    name: ealYoeM7z
spec:
    annotations:
        list:
            - builtIn: 1
              datasource:
                type: datasource
                uid: grafana
              enable: true
              hide: true
              iconColor: rgba(0, 211, 255, 1)
              name: Annotations & Alerts
              target:
                limit: 100
                matchAny: false
                tags: []
                type: dashboard
              type: dashboard
    description: Parsing Envoy access logs with Grafana Loki
    editable: true
    fiscalYearStartMonth: 0
    graphTooltip: 0
    links: []
    panels:
        - collapsed: false
          gridPos:
            h: 1
            w: 24
            x: 0
            "y": 0
          id: 24
          panels: []
          title: KPI's
          type: row
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: purple
                unit: short
            overrides: []
          gridPos:
            h: 4
            w: 5
            x: 0
            "y": 1
          hideTimeOverride: false
          id: 4
          maxDataPoints: 300
          options:
            colorMode: background
            graphMode: area
            justifyMode: center
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - sum
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: value
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: 'sum by(host) (count_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"}[$__interval]))  '
              legendFormat: ""
              queryType: range
              refId: A
          timeFrom: 24h
          title: 'Total requests  '
          type: stat
        - datasource:
            type: loki
            uid: felmlj6wx3i80e
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                mappings: []
                thresholds:
                    mode: percentage
                    steps:
                        - color: rgba(110, 157, 228, 0.76)
                        - color: rgba(73, 124, 202, 1)
                          value: 20
                unit: short
            overrides: []
          gridPos:
            h: 8
            w: 7
            x: 5
            "y": 1
          id: 5
          maxDataPoints: 20
          options:
            colorMode: value
            graphMode: area
            justifyMode: auto
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - sum
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: auto
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                type: loki
                uid: felmlj6wx3i80e
              expr: "sum by (status_code) (count_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"} \n| pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`  | __error__=\"\"\n | status_code =~\"0|2..|3..|4..|5..\" \n[$__interval])) "
              legendFormat: '{{status_code}}'
              refId: A
          title: Requests per status code
          type: stat
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                decimals: 0
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-orange
                unit: decbytes
            overrides: []
          gridPos:
            h: 4
            w: 3
            x: 12
            "y": 1
          id: 30
          maxDataPoints: 1
          options:
            colorMode: background
            graphMode: none
            justifyMode: auto
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - sum
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: auto
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              expr: bytes_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"}[$__interval])
              instant: true
              legendFormat: $label_value
              range: false
              refId: A
          title: Istio logs in bytes
          type: stat
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: purple
                unit: decbytes
            overrides: []
          gridPos:
            h: 4
            w: 3
            x: 15
            "y": 1
          id: 8
          maxDataPoints: 1
          options:
            colorMode: background
            graphMode: none
            justifyMode: center
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - sum
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: value
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: |-
                sum by (upstream_cluster) (sum_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"}
                | pattern `<_> "<method> <path> <protocol>" <status_code> <response_flags> <response_code_details> <connection_termination_details> "<failure_reason>" <bytes_received> <bytes_sent> <duration> <upstream_time> "<forward_for>" "<agent>" "<req_id>" "<authority>" "<upstream_host>" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`
                | unwrap bytes_sent
                |  __error__=""
                [$__interval]))
              hide: false
              queryType: range
              refId: B
          title: Total Bytes Sent
          type: stat
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults: {}
            overrides: []
          gridPos:
            h: 4
            w: 6
            x: 18
            "y": 1
          id: 11
          options:
            dedupStrategy: signature
            enableInfiniteScrolling: false
            enableLogDetails: false
            prettifyLogMessage: false
            showCommonLabels: false
            showLabels: false
            showTime: false
            sortOrder: Descending
            wrapLogMessage: false
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              expr: |-
                {$label_name=~"$label_value", job=~"$job", instance=~"$instance"}
                | pattern `<_> "<method> <path> <protocol>" <status_code> <response_flags> <response_code_details> <connection_termination_details> "<failure_reason>" <bytes_received> <bytes_sent> <duration> <upstream_time> "<forward_for>" "<agent>" "<req_id>" "<authority>" "<upstream_host>" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`
                | line_format "{{ .method }} request to {{ .path }} with HTTP status: {{.status_code }}"
              hide: false
              refId: B
          title: Recent requests
          type: logs
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: purple
            overrides: []
          gridPos:
            h: 4
            w: 5
            x: 0
            "y": 5
          id: 22
          interval: 5m
          options:
            colorMode: background
            graphMode: none
            justifyMode: auto
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - mean
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: value
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              expr: |-
                count (sum by (downstream_remote_address) (count_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"}
                | pattern `<_> "<method> <path> <protocol>" <status_code> <response_flags> <response_code_details> <connection_termination_details> "<failure_reason>" <bytes_received> <bytes_sent> <duration> <upstream_time> "<forward_for>" "<agent>" "<req_id>" "<authority>" "<upstream_host>" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`
                [$__interval])))
              hide: false
              refId: B
          timeFrom: 5m
          title: 'Realtime visitors '
          type: stat
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                decimals: 0
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-orange
                unit: short
            overrides: []
          gridPos:
            h: 4
            w: 3
            x: 12
            "y": 5
          id: 31
          maxDataPoints: 1
          options:
            colorMode: background
            graphMode: none
            justifyMode: auto
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - sum
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: auto
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              expr: count_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"}[$__interval])
              instant: true
              range: false
              refId: A
          title: '# Istio log lines'
          type: stat
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                decimals: 1
                mappings: []
                max: 100
                min: 0
                thresholds:
                    mode: absolute
                    steps:
                        - color: purple
                        - color: red
                          value: 80
                unit: percent
            overrides: []
          gridPos:
            h: 4
            w: 3
            x: 15
            "y": 5
          hideTimeOverride: true
          id: 19
          maxDataPoints: 1
          options:
            colorMode: background
            graphMode: none
            justifyMode: center
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - max
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: value
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: "sum(count_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"} | pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>` \n| status_code >= 500 |__error__=\"\" [$__interval]))\n/\n(sum(count_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"} | pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>` \n| __error__=\"\" [$__interval])) / 100)"
              hide: false
              queryType: range
              refId: B
          timeFrom: 1h
          title: '% of 5xx requests '
          type: stat
        - datasource:
            type: loki
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                mappings: []
                max: 100
                min: 0
                thresholds:
                    mode: absolute
                    steps:
                        - color: purple
                unit: percent
            overrides: []
          gridPos:
            h: 4
            w: 6
            x: 18
            "y": 5
          hideTimeOverride: true
          id: 35
          interval: 10m
          maxDataPoints: 1
          options:
            colorMode: background
            graphMode: none
            justifyMode: auto
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - last
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: value
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                type: loki
                uid: felmlj6wx3i80e
              expr: sum(count_over_time(({$label_name=~"$label_value", job=~"$job", instance=~"$instance"} |~ "Googlebot|Slack.+")[$__interval])) / (sum(count_over_time(({$label_name=~"$label_value", job=~"$job", instance=~"$instance"} !~ "Googlebot|Slack.+")[$__interval])) / 100)
              instant: true
              legendFormat: ""
              range: false
              refId: A
          timeFrom: 1h
          title: '% of requests by bots'
          type: stat
        - collapsed: false
          gridPos:
            h: 1
            w: 24
            x: 0
            "y": 9
          id: 26
          panels: []
          title: Request statistics over time
          type: row
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    barAlignment: 0
                    barWidthFactor: 0.6
                    drawStyle: line
                    fillOpacity: 91
                    gradientMode: opacity
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    insertNulls: false
                    lineInterpolation: smooth
                    lineWidth: 1
                    pointSize: 5
                    scaleDistribution:
                        log: 2
                        type: log
                    showPoints: never
                    spanNulls: false
                    stacking:
                        group: A
                        mode: none
                    thresholdsStyle:
                        mode: area
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: green
                        - color: '#EAB839'
                          value: 50
                        - color: red
                          value: 100
                unit: ms
            overrides:
                - matcher:
                    id: byName
                    options: 95th percentile
                  properties:
                    - id: color
                      value:
                        fixedColor: blue
                        mode: fixed
                - matcher:
                    id: byName
                    options: max latency
                  properties:
                    - id: color
                      value:
                        fixedColor: super-light-blue
                        mode: fixed
                - matcher:
                    id: byName
                    options: max latency
                  properties:
                    - id: custom.fillOpacity
                      value: 30
          gridPos:
            h: 9
            w: 8
            x: 0
            "y": 10
          id: 16
          maxDataPoints: 50
          options:
            legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: true
            tooltip:
                hideZeros: false
                mode: single
                sort: none
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: "quantile_over_time(0.95,{$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"}\n| pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`\n| unwrap duration \n|  __error__=\"\"  [$__interval]) by (host)"
              hide: false
              legendFormat: 95th percentile
              queryType: range
              refId: A
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: "max by (host) (max_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"}| pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>` \n| unwrap duration \n|  __error__=\"\"  [$__interval]))"
              hide: false
              legendFormat: max latency
              queryType: range
              refId: B
          title: 95th percentile of duration
          type: timeseries
        - datasource:
            type: loki
            uid: felmlj6wx3i80e
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    barAlignment: 0
                    barWidthFactor: 0.6
                    drawStyle: line
                    fillOpacity: 37
                    gradientMode: opacity
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    insertNulls: false
                    lineInterpolation: smooth
                    lineStyle:
                        fill: solid
                    lineWidth: 1
                    pointSize: 4
                    scaleDistribution:
                        type: linear
                    showPoints: auto
                    spanNulls: false
                    stacking:
                        group: A
                        mode: none
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: percentage
                    steps:
                        - color: rgba(110, 157, 228, 0.76)
                        - color: rgba(73, 124, 202, 1)
                          value: 20
                unit: short
            overrides:
                - matcher:
                    id: byName
                    options: '{status_code="404"}'
                  properties:
                    - id: color
                      value:
                        fixedColor: semi-dark-blue
                        mode: fixed
          gridPos:
            h: 9
            w: 8
            x: 8
            "y": 10
          id: 33
          maxDataPoints: 20
          options:
            legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: true
            tooltip:
                hideZeros: false
                mode: single
                sort: none
          pluginVersion: 11.6.0
          targets:
            - datasource:
                type: loki
                uid: felmlj6wx3i80e
              direction: backward
              editorMode: code
              expr: "sum by (status_code) (count_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"} \n| pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`  | __error__=\"\"\n | status_code =~\"0|2..|3..|4..|5..\" \n[$__interval])) "
              queryType: range
              refId: A
          title: Requests per status code
          type: timeseries
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    barAlignment: 0
                    barWidthFactor: 0.6
                    drawStyle: line
                    fillOpacity: 100
                    gradientMode: opacity
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    insertNulls: false
                    lineInterpolation: smooth
                    lineWidth: 1
                    pointSize: 5
                    scaleDistribution:
                        type: linear
                    showPoints: never
                    spanNulls: false
                    stacking:
                        group: A
                        mode: none
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: green
                        - color: red
                          value: 80
                unit: decbytes
            overrides:
                - matcher:
                    id: byName
                    options: Bytes sent
                  properties:
                    - id: color
                      value:
                        fixedColor: light-blue
                        mode: fixed
                - matcher:
                    id: byName
                    options: appfelstrudel
                  properties:
                    - id: color
                      value:
                        fixedColor: yellow
                        mode: fixed
          gridPos:
            h: 9
            w: 8
            x: 16
            "y": 10
          id: 9
          maxDataPoints: 50
          options:
            legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: true
            tooltip:
                hideZeros: false
                mode: single
                sort: none
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              expr: sum by (host) (sum_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"} | json | status=200 | unwrap body_bytes_sent |  __error__="" [$__interval]))
              hide: true
              legendFormat: Bytes sent
              refId: A
            - datasource:
                uid: $datasource
              expr: "sum by (host) (sum_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"} | pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`\n| status_code=200 \n| unwrap bytes_sent\n|  __error__=\"\" [$__interval]))"
              hide: false
              legendFormat: Bytes sent
              refId: B
          title: Bytes Sent
          type: timeseries
        - collapsed: false
          gridPos:
            h: 1
            w: 24
            x: 0
            "y": 19
          id: 28
          panels: []
          title: Acquisition and Behaviour
          type: row
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: green
                        - color: red
                          value: 80
                unit: ms
            overrides: []
          gridPos:
            h: 8
            w: 16
            x: 0
            "y": 20
          id: 7
          maxDataPoints: 1
          options:
            colorMode: value
            graphMode: area
            justifyMode: auto
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - lastNotNull
                fields: ""
                values: false
            showPercentChange: false
            text: {}
            textMode: auto
            wideLayout: true
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: "max_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"}\n!~ `.ico|.svg|.css|.png|.txt|.js|.xml`\n| pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`\n| unwrap duration\n| status_code = 200 and path != \"/\" \n| __error__=\"\" [5m]) by (path)"
              hide: false
              legendFormat: '{{path}} '
              queryType: range
              refId: B
          timeFrom: 1h
          title: Top 10 paths by duration in last 1h
          transformations:
            - id: organize
              options:
                excludeByName:
                    Field: false
                    Time: true
                indexByName: {}
                renameByName:
                    Field: Agent
                    Total: Requests
                    'Value #A': Requests
                    http_user_agent: User agent
          type: stat
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                custom:
                    align: auto
                    cellOptions:
                        type: auto
                    filterable: false
                    inspect: false
                mappings:
                    - options:
                        NL:
                            index: 1
                            text: ??
                        US:
                            index: 0
                            text: ??
                      type: value
                thresholds:
                    mode: absolute
                    steps:
                        - color: green
                        - color: red
                          value: 80
            overrides:
                - matcher:
                    id: byName
                    options: Requests
                  properties:
                    - id: custom.width
                      value: 300
                    - id: custom.cellOptions
                      value:
                        mode: gradient
                        type: gauge
                    - id: color
                      value:
                        mode: continuous-BlPu
                - matcher:
                    id: byName
                    options: Country
                  properties:
                    - id: custom.width
                      value: 74
          gridPos:
            h: 8
            w: 8
            x: 16
            "y": 20
          id: 3
          maxDataPoints: 1
          options:
            cellHeight: sm
            footer:
                countRows: false
                fields: ""
                reducer:
                    - sum
                show: false
            showHeader: true
            sortBy:
                - desc: true
                  displayName: Requests
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              expr: topk(10, sum by (forward_for) (count_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"} | pattern `<_> "<method> <path> <protocol>" <status_code> <response_flags> <response_code_details> <connection_termination_details> "<failure_reason>" <bytes_received> <bytes_sent> <duration> <upstream_time> "<forward_for>" "<agent>" "<req_id>" "<authority>" "<upstream_host>" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>` |  __error__="" [$__interval])))
              instant: true
              legendFormat: '{{remote_addr}}'
              range: false
              refId: A
          timeFrom: 15m
          title: Top 10 visitor IPs
          transformations:
            - id: organize
              options:
                excludeByName:
                    Field: false
                    Time: true
                indexByName:
                    Time: 0
                    'Value #A': 3
                    geoip_country_code: 2
                    remote_addr: 1
                renameByName:
                    Field: IP Address
                    Total: Requests
                    'Value #A': Requests
                    geoip_country_code: Country
                    remote_addr: 'IP Address '
          type: table
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    axisSoftMin: 0
                    fillOpacity: 80
                    gradientMode: none
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    lineWidth: 1
                    scaleDistribution:
                        type: linear
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: green
                        - color: red
                          value: 80
                unit: short
            overrides: []
          gridPos:
            h: 8
            w: 24
            x: 0
            "y": 28
          id: 12
          maxDataPoints: 1
          options:
            barRadius: 0
            barWidth: 0.97
            fullHighlight: false
            groupWidth: 0.7
            legend:
                calcs: []
                displayMode: list
                placement: right
                showLegend: false
            orientation: horizontal
            showValue: never
            stacking: none
            tooltip:
                hideZeros: false
                mode: single
                sort: none
            xTickLabelRotation: 0
            xTickLabelSpacing: 0
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: "topk(10, sum by (path) (count_over_time({$label_name=~\"$label_value\", job=~\"$job\", instance=~\"$instance\"} \n!~ `.ico|.svg|.css|.png|.txt|.js|.xml`\n| pattern `<_> \"<method> <path> <protocol>\" <status_code> <response_flags> <response_code_details> <connection_termination_details> \"<failure_reason>\" <bytes_received> <bytes_sent> <duration> <upstream_time> \"<forward_for>\" \"<agent>\" \"<req_id>\" \"<authority>\" \"<upstream_host>\" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`\n| status_code = 200 and path != \"/\" \n| __error__=\"\" [1d])))"
              instant: true
              legendFormat: '{{request_uri}}'
              queryType: range
              range: false
              refId: A
          timeFrom: 1d
          title: Top 10 Requested Pages
          transformations:
            - id: organize
              options:
                excludeByName:
                    Time: true
                indexByName: {}
                renameByName:
                    Field: Page
                    Time: ""
                    Total: ""
                    'Value #A': Requests
                    request_uri: Path
          type: barchart
        - datasource:
            uid: $datasource
          description: ""
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    axisSoftMin: 0
                    fillOpacity: 80
                    gradientMode: none
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    lineWidth: 1
                    scaleDistribution:
                        type: linear
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: green
                        - color: red
                          value: 80
                unit: short
            overrides: []
          gridPos:
            h: 8
            w: 24
            x: 0
            "y": 36
          id: 36
          maxDataPoints: 1
          options:
            barRadius: 0
            barWidth: 0.97
            fullHighlight: false
            groupWidth: 0.7
            legend:
                calcs: []
                displayMode: list
                placement: right
                showLegend: false
            orientation: horizontal
            showValue: never
            stacking: none
            tooltip:
                hideZeros: false
                mode: single
                sort: none
            xTickLabelRotation: 0
            xTickLabelSpacing: 0
          pluginVersion: 11.6.0
          targets:
            - datasource:
                uid: $datasource
              direction: backward
              editorMode: code
              expr: |-
                topk(10, sum by (agent) (count_over_time({$label_name=~"$label_value", job=~"$job", instance=~"$instance"} | pattern `<_> "<method> <path> <protocol>" <status_code> <response_flags> <response_code_details> <connection_termination_details> "<failure_reason>" <bytes_received> <bytes_sent> <duration> <upstream_time> "<forward_for>" "<agent>" "<req_id>" "<authority>" "<upstream_host>" <upstream_cluster> <upstream_local_address> <downstream_local_address> <downstream_remote_address> <requested_server_name> <route_name>`
                | __error__="" [1h])))
              instant: true
              legendFormat: '{{http_user_agent}}'
              queryType: range
              range: false
              refId: A
          timeFrom: 1d
          title: Top 10 User Agents
          transformations:
            - id: organize
              options:
                excludeByName:
                    Field: false
                    Time: true
                indexByName: {}
                renameByName:
                    Field: Agent
                    Total: Requests
                    'Value #A': Requests
                    http_user_agent: User agent
          type: barchart
    preload: false
    refresh: ""
    schemaVersion: 41
    tags: []
    templating:
        list:
            - current:
                text: logs-gke-prod-kasha
                value: felmlj6wx3i80e
              includeAll: false
              label: Datasource
              name: datasource
              options: []
              query: loki
              refresh: 1
              regex: ""
              type: datasource
            - current:
                text: container
                value: container
              datasource:
                uid: $datasource
              definition: label_names()
              includeAll: false
              label: Label name
              name: label_name
              options: []
              query: label_names()
              refresh: 1
              regex: ""
              sort: 1
              type: query
            - current:
                text:
                    - istio-proxy
                value:
                    - istio-proxy
              datasource:
                uid: $datasource
              definition: label_values($label_name)
              includeAll: true
              label: Label Value
              multi: true
              name: label_value
              options: []
              query: label_values($label_name)
              refresh: 1
              regex: ""
              sort: 1
              type: query
            - current:
                text:
                    - All
                value:
                    - $__all
              datasource:
                uid: $datasource
              definition: label_values({$label_name=~"$label_value"}, job)
              includeAll: true
              label: Job
              multi: true
              name: job
              options: []
              query: label_values({$label_name=~"$label_value"}, job)
              refresh: 1
              regex: ""
              type: query
            - current:
                text: All
                value: $__all
              datasource:
                uid: $datasource
              definition: label_values({$label_name=~"$label_value"}, instance)
              includeAll: true
              label: Instance
              multi: true
              name: instance
              options: []
              query: label_values({$label_name=~"$label_value"}, instance)
              refresh: 1
              regex: ""
              type: query
    time:
        from: now-15m
        to: now
    timepicker:
        refresh_intervals:
            - 10s
            - 30s
            - 1m
            - 5m
            - 15m
            - 30m
            - 1h
            - 2h
            - 1d
    timezone: ""
    title: Grafana Loki Dashboard for Istio Service Mesh
    uid: ealYoeM7z
